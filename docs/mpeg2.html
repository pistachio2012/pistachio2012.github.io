<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Chromium浏览器的定制与优化，及二次开发">
  <meta name="keywords" content="Chromium 浏览器 定制 优化 二次开发">
  <meta name="author" content="pistachio2012@126.com">
  <meta name="robots" content="index, follow">
  <title>Chromium定制及二次开发</title>
</head>
<body>
<h1>Chromium定制及二次开发:添加mpeg2解码</h1>
<h2 id="chromium-ffmpeg-">Chromium中ffmpeg相关类</h2>
<h3 id="ffmpegdemuxer">FFmpegDemuxer</h3>
<p>Chromium在解析video或audio标签后会创建对应的WebMediaPlayerImpl，如果网络资源不是MediaSource，那么就会创建FFmpegDemuxer，并且保存到demuxer_。再通过Pipeline调用FFmpegDemuxer::Initialize时创建FFmpegGlue，并且开始demux。</p>
<h3 id="ffmpegglue">FFmpegGlue</h3>
<p>在构造函数中会调用avformat_alloc_context创建avformat，然后在异步调用FFmpegGlue::OpenContext函数开始demux。主要就是调用avformat_open_input让ffmpeg进行demux并返回结果。</p>
<h3 id="ffmpegdemuxer">FFmpegDemuxer</h3>
<p>FFmpegGlue返回成功demux后，异步调用avformat_find_stream_info找到音视频的信息，并将结果传递给FFmpegDemuxer::OnFindStreamInfoDone，并且为每个AVStream创建对应的FFmpegDemuxerStream。</p>
<h3 id="ffmpegvideodecoder">FFmpegVideoDecoder</h3>
<p>解析出音视频信息后，异步调用WebMediaPlayerImpl::CreateRenderer并通过DefaultRendererFactory创建Renderer，Renderer中包括音频AudioRendererImpl和视频VideoRendererImpl，然后会异步调用RendererImpl::Initialize初始化，并先异步初始化AudioRendererImpl::Initialize，后异步初始化VideoRendererImpl::Initialize，其中会创建并初始化VideoDecoderStream，其中会异步调用DefaultRendererFactory::CreateVideoDecoders来创建多个Decoders，其中最重要的是FFmpegVideoDecoder。
异步调用DecoderStreamTraits<DemuxerStream::VIDEO>::InitializeDecoder中会调用FFmpegVideoDecoder::Initialize来初始化，其中调用FFmpegVideoDecoder::ConfigureDecoder来配置ffmpeg，首先调用avcodec_alloc_context3来创建AVCodecContext，然后调用VideoDecoderConfigToAVCodecContext设置context，然后调用avcodec_find_decoder和avcodec_open2找到并打开AVCodec，最后创建FFmpegDecodingLoop。</p>
<h3 id="-">编码资源数据流</h3>
<p>从网络上下载数据后会MultiBufferDataSource，并且通过BlockingUrlProtocol传递给ffmpeg，FFmpegDemuxer从ffmpeg读出AVPacket后，通过FFmpegDemuxerStream转换成DecoderBuffer，再传递给DecoderStream&lt;&gt;，将buffer整合后传递给FFmpegVideoDecoder，这里生成AVPacket传到FFmpegDecodingLoop进行ffmpeg解码。</p>
<h2 id="chromium-mpeg2">Chromium中增加mpeg2</h2>
<h3 id="ffmpeg-config">ffmpeg修改config</h3>
<p>修改ffmpeg中的config文件，config_components.h文件中有mpeg2的宏定义，如CONFIG_MPEG2VIDEO_DECODER ，config.h文件中也定义了mpeg2相关的宏定义，如CONFIG_MPEGVIDEO。</p>
<h3 id="ffmpeg-">ffmpeg增加编译文件</h3>
<p>ffmpeg是模块化的，如果要增加新的解码模块，那么需要将其相关的文件添加到编译目标中，这主要是修改ffmpeg_generated.gni，如libavcodec/mpeg12dec.c等。</p>
<h3 id="ffmpeg-">ffmpeg增加解码类</h3>
<p>ffmpeg需要将增加的解码类添加到解码列表中，这样就能被找到了，这主要是修改codec_list.c，如ff_mp2_decoder等</p>
<h3 id="ffmpeg-">ffmpeg增加解析类</h3>
<p>ffmpeg也需要增加解析类到列表中，这主要是修改parser_list.c，如ff_mpegvideo_parser等</p>
<h3 id="ffmpeg-">ffmpeg增加新的容器类</h3>
<p>如果要增加新的容器类，那么要在解复用列表中添加容器类，这主要是修改demuxer_list.c，同时要在ffmpeg_generated.gni中增加相应的源码文件，如ff_mpegps_demuxer等。</p>
</body>
</html>

